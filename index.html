<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0" />
    <title>Market Open Countdown</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Luxon for robust timezone/DST handling -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
        rel="preconnect"
        href="https://fonts.gstatic.com"
        crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;700&display=swap"
        rel="stylesheet" />

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }
        .status-open {
            background-color: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }
        .status-closed {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }
        .card-glow {
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1), 0 0 5px rgba(0, 255, 255, 0.1);
        }
        .overlap-glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.7), 0 0 8px rgba(59, 130, 246, 0.5);
            border-color: rgba(96, 165, 250, 0.8);
        }
        .bell-icon {
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        .bell-icon.active {
            color: #38bdf8;
        }
        .bell-icon:hover {
            color: #7dd3fc;
        }

        /* Toast fallback for environments without notifications */
        .toast {
            position: fixed;
            right: 16px;
            bottom: 16px;
            background-color: rgba(31, 41, 55, 0.95);
            color: #e5e7eb;
            border: 1px solid #374151;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            z-index: 9999;
            opacity: 0;
            transform: translateY(6px);
            transition: opacity .2s ease, transform .2s ease;
            max-width: 320px;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #93c5fd;
        }
        .toast-body {
            font-size: 0.9rem;
            line-height: 1.25rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4 md:p-8 max-w-7xl w-full flex flex-col items-center">
        <div id="header-container" class="text-center w-full">
            <div id="header-toggle" class="flex justify-center items-center gap-2 cursor-pointer mb-4">
                <h1 class="text-4xl md:text-5xl font-bold text-white">
                    Global Market Hours
                </h1>
                <svg id="header-arrow" class="w-6 h-6 text-gray-400 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                </svg>
            </div>

            <div id="collapsible-section" class="transition-all duration-500 ease-in-out overflow-hidden">
                <div class="pb-6">
                    <p class="text-gray-400 mt-2">Live status based on your local time</p>
                    <p id="secure-warning" class="mt-3 text-sm text-amber-300 hidden">
                        For notifications to work in Chrome, open this page via https:// or http://localhost
                        (notifications/service workers are blocked on file://).
                    </p>

                    <div class="flex justify-center gap-4 items-center flex-wrap my-3">
                         <p id="settings-toggle" class="text-sm text-gray-400 cursor-pointer hover:text-gray-300 transition-colors duration-200">Settings</p>
                    </div>
                    <div id="settings-panel" class="bg-gray-800 border border-gray-700 rounded-lg p-4 mb-4 max-w-xl mx-auto text-left" style="display: none;">
                        <div class="flex items-center gap-3 mb-3">
                            <input id="setting-preopen" type="checkbox" class="h-4 w-4">
                            <label for="setting-preopen" class="text-sm">Notify before open</label>
                        </div>
                        <div class="flex items-center gap-3 mb-3 ml-7">
                            <label for="setting-lead" class="text-sm w-48">Lead time (minutes)</label>
                            <input id="setting-lead" type="number" min="1" max="240" class="bg-gray-900 border border-gray-700 rounded px-2 py-1 w-24 text-sm" />
                        </div>
                        <div class="flex items-center gap-3 mb-4">
                            <input id="setting-open" type="checkbox" class="h-4 w-4">
                            <label for="setting-open" class="text-sm">Notify at open</label>
                        </div>
                        <div class="flex gap-2">
                            <button id="settings-save" class="bg-green-600 hover:bg-green-700 text-white font-medium py-1.5 px-3 rounded">Save</button>
                            <button id="settings-reset" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-1.5 px-3 rounded">Reset Defaults</button>
                        </div>
                    </div>
                    <div id="debug-buttons" class="flex gap-4 justify-center items-center flex-wrap mb-2" style="display: none;">
                        <button id="test-notification" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                            Test Notifications
                        </button>
                        <button id="check-settings" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                            Check Browser Settings
                        </button>
                    </div>
                    <p id="debug-toggle" class="text-xs text-gray-500 cursor-pointer hover:text-gray-300 transition-colors duration-200" title="Click to show notification testing tools">
                        Having notification issues? Click here for help
                    </p>
                </div>
            </div>
        </div>

        <main id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Market cards will be dynamically injected here -->
        </main>
    </div>

    <script>
        const { DateTime, Duration } = luxon;

        // --- Configuration (market local times; Luxon will handle DST automatically) ---
        // days: 1-5 = Mon-Fri (Luxon DateTime.weekday uses 1..7 where 7=Sun)
        const baseMarkets = [
            {
                name: 'New York',
                localOpen: 9.5, // 9:30
                localClose: 16,
                timezone: 'America/New_York',
                days: [1, 2, 3, 4, 5],
                alertEnabled: false,
                alertSent: false
            },
            {
                name: 'London',
                localOpen: 8, // 8:00
                localClose: 16.5, // 16:30
                timezone: 'Europe/London',
                days: [1, 2, 3, 4, 5],
                alertEnabled: false,
                alertSent: false
            },
            {
                name: 'Tokyo',
                localOpen: 9, // 9:00 (continuous session for simplicity)
                localClose: 15, // 15:00
                timezone: 'Asia/Tokyo',
                days: [1, 2, 3, 4, 5],
                alertEnabled: false,
                alertSent: false
            },
            {
                name: 'Sydney',
                localOpen: 10, // 10:00
                localClose: 16, // 16:00
                timezone: 'Australia/Sydney',
                days: [1, 2, 3, 4, 5],
                alertEnabled: false,
                alertSent: false
            }
        ];

        const userZone = Intl.DateTimeFormat().resolvedOptions().timeZone || DateTime.local().zoneName;
        let markets = JSON.parse(JSON.stringify(baseMarkets));

        function loadAlertSettings() {
            try {
                const raw = localStorage.getItem('mhAlerts');
                return raw ? JSON.parse(raw) : {};
            } catch (e) {
                console.warn('Could not load alert settings', e);
                return {};
            }
        }
        function saveAlertSettings() {
            try {
                const settingsToSave = {};
                markets.forEach(m => {
                    settingsToSave[m.name.toLowerCase()] = m.alertEnabled;
                });
                localStorage.setItem('mhAlerts', JSON.stringify(settingsToSave));
            } catch (e) {
                console.warn('Could not save alert settings', e);
            }
        }

        // Load and apply persistent alert settings
        const alertSettings = loadAlertSettings();
        markets.forEach(m => {
            if (alertSettings[m.name.toLowerCase()] !== undefined) {
                m.alertEnabled = alertSettings[m.name.toLowerCase()];
            }
        });

        // Notification + Service Worker setup
        let notificationPermissionGranted = false;
        let swRegistration = null;

        const defaultSettings = { preOpenEnabled: true, openEnabled: true, preOpenLeadMinutes: 5 };

        function loadSettings() {
            try {
                const raw = localStorage.getItem('mhSettings');
                const parsed = raw ? JSON.parse(raw) : {};
                return {
                    preOpenEnabled: parsed.preOpenEnabled !== undefined ? parsed.preOpenEnabled : defaultSettings.preOpenEnabled,
                    openEnabled: parsed.openEnabled !== undefined ? parsed.openEnabled : defaultSettings.openEnabled,
                    preOpenLeadMinutes: Number.isFinite(parsed.preOpenLeadMinutes) ? parsed.preOpenLeadMinutes : defaultSettings.preOpenLeadMinutes
                };
            } catch (e) {
                return { ...defaultSettings };
            }
        }
        function saveSettings() {
            try {
                localStorage.setItem('mhSettings', JSON.stringify(settings));
            } catch (e) {
                // ignore
            }
        }
        let settings = loadSettings();

        function isSecure() {
            return window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        }

        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                console.log('Service Worker not supported in this browser.');
                return null;
            }
            if (!isSecure()) {
                console.log('Not a secure context; cannot register Service Worker.');
                return null;
            }
            try {
                const reg = await navigator.serviceWorker.register('market-sw.js');
                await navigator.serviceWorker.ready;
                console.log('Service Worker registered:', reg.scope);
                return reg;
            } catch (err) {
                console.error('Service Worker registration failed:', err);
                return null;
            }
        }

        function getNotificationPermission() {
            if (!('Notification' in window)) return 'not-supported';
            if (notificationPermissionGranted) return 'granted';
            return Notification.permission;
        }

        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Notifications not supported in this browser.');
                return false;
            }
            if (getNotificationPermission() === 'granted') {
                notificationPermissionGranted = true;
                return true;
            }
            if (getNotificationPermission() === 'denied') {
                return false;
            }
            try {
                const perm = await Notification.requestPermission();
                if (perm === 'granted') {
                    notificationPermissionGranted = true;
                    return true;
                }
                return false;
            } catch (e) {
                console.error('Permission request error:', e);
                return false;
            }
        }

        function canUseSWNotifications() {
            return !!swRegistration && typeof swRegistration.showNotification === 'function';
        }

        function showToast(title, body) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerHTML = `
                <div class="toast-title">${title}</div>
                <div class="toast-body">${body || ''}</div>
            `;
            document.body.appendChild(t);
            // Force layout to enable transition
            void t.offsetWidth;
            t.classList.add('show');
            setTimeout(() => {
                t.classList.remove('show');
                setTimeout(() => t.remove(), 200);
            }, 4000);
        }

        async function notify(title, body, tag) {
            const options = {
                body,
                tag,
                renotify: true,
                requireInteraction: false,
                silent: false
            };

            if (getNotificationPermission() !== 'granted') {
                const granted = await requestNotificationPermission();
                if (!granted) {
                    showToast(title, body);
                    return false;
                }
            }

            try {
                if (canUseSWNotifications()) {
                    await swRegistration.showNotification(title, options);
                    return true;
                }
                if ('Notification' in window && Notification.permission === 'granted') {
                    const n = new Notification(title, options);
                    // Auto-close after 10s to avoid lingering
                    setTimeout(() => n.close(), 10000);
                    return true;
                }
            } catch (e) {
                console.error('Notification error:', e);
            }
            // Fallback toast
            showToast(title, body);
            return false;
        }

        // --- Time helpers (Luxon) ---
        function toHourMinute(decimalHour) {
            const h = Math.floor(decimalHour);
            const m = Math.round((decimalHour - h) * 60);
            return { h, m };
        }

        function isBusinessDayInZone(dtZ, allowedWeekdays) {
            // Luxon weekday: 1..7 (Mon..Sun)
            return allowedWeekdays.includes(dtZ.weekday);
        }

        function openCloseOnDay(market, dayZ) {
            const { h: oh, m: om } = toHourMinute(market.localOpen);
            const { h: ch, m: cm } = toHourMinute(market.localClose);

            let openZ = dayZ.startOf('day').set({ hour: oh, minute: om, second: 0, millisecond: 0 });
            let closeZ = dayZ.startOf('day').set({ hour: ch, minute: cm, second: 0, millisecond: 0 });

            // Overnight session handling (if close time <= open time, close is next day)
            if (closeZ <= openZ) {
                closeZ = closeZ.plus({ days: 1 });
            }
            return { openZ, closeZ };
        }

        function nextBusinessOpen(market, nowZ) {
            // If today is a business day and before today's open, return today's open
            const todayOpenClose = openCloseOnDay(market, nowZ);
            if (isBusinessDayInZone(nowZ, market.days) && nowZ < todayOpenClose.openZ) {
                return todayOpenClose.openZ;
            }

            // Otherwise, iterate forward to next allowed weekday
            let probe = nowZ.plus({ days: 1 }).startOf('day');
            for (let i = 0; i < 14; i++) { // safe guard
                if (isBusinessDayInZone(probe, market.days)) {
                    return openCloseOnDay(market, probe).openZ;
                }
                probe = probe.plus({ days: 1 });
            }
            // Fallback (shouldn't happen)
            return todayOpenClose.openZ;
        }

        function isOpenNow(market, nowZ) {
            // Check today's window
            const { openZ, closeZ } = openCloseOnDay(market, nowZ);
            if (isBusinessDayInZone(nowZ, market.days) && nowZ >= openZ && nowZ < closeZ) {
                return true;
            }
            // If overnight, it may have opened yesterday and still be open after midnight
            const yesterday = nowZ.minus({ days: 1 });
            const y = openCloseOnDay(market, yesterday);
            if (isBusinessDayInZone(yesterday, market.days) && nowZ >= y.openZ && nowZ < y.closeZ) {
                return true;
            }
            return false;
        }

        // --- UI Build ---
        const dashboard = document.getElementById('dashboard');

        function formatToUserLocal(dtZ) {
            return dtZ.setZone(userZone).toLocaleString(DateTime.TIME_SIMPLE);
        }

        function initializeDashboard() {
            dashboard.innerHTML = '';

            markets.forEach((market, index) => {
                const card = document.createElement('div');
                card.id = `card-${market.name.toLowerCase()}`;
                card.className =
                    'bg-gray-800/50 backdrop-blur-sm border border-gray-700 p-6 rounded-xl shadow-lg flex flex-col items-center transition-all duration-300 card-glow';

                const nowZ = DateTime.now().setZone(market.timezone);
                const { h: oh, m: om } = toHourMinute(market.localOpen);
                const { h: ch, m: cm } = toHourMinute(market.localClose);

                const openZ = nowZ.set({ hour: oh, minute: om, second: 0, millisecond: 0 });
                const closeZ = (ch > oh || (ch === oh && cm > om))
                    ? nowZ.set({ hour: ch, minute: cm, second: 0, millisecond: 0 })
                    : nowZ.plus({ days: 1 }).set({ hour: ch, minute: cm, second: 0, millisecond: 0 });

                const opensLocalDisplay = formatToUserLocal(openZ);
                const closesLocalDisplay = formatToUserLocal(closeZ);

                card.innerHTML = `
                    <div class="w-full flex justify-between items-center">
                        <h2 class="text-2xl font-semibold text-cyan-400">${market.name}</h2>
                        <svg id="bell-${index}" class="w-6 h-6 text-gray-500 bell-icon ${market.alertEnabled ? 'active' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    </div>
                    <div id="${market.name.toLowerCase()}-status" class="text-3xl lg:text-4xl font-mono my-4 px-4 py-2 rounded-lg w-full text-center transition-colors duration-300">
                        --:--:--
                    </div>
                    <div class="text-sm text-gray-400 text-center">
                        <p>Opens: ${opensLocalDisplay}</p>
                        <p>Closes: ${closesLocalDisplay}</p>
                    </div>
                `;
                dashboard.appendChild(card);

                document.getElementById(`bell-${index}`).addEventListener('click', () => {
                    toggleAlert(index);
                });
            });

            // Event listeners for header controls are now in DOMContentLoaded
        }

        async function toggleAlert(marketIndex) {
            // Pre-flight permission
            if (getNotificationPermission() === 'denied') {
                alert('You have blocked notifications. Enable them in your browser settings and reload.');
                return;
            }
            if (getNotificationPermission() !== 'granted') {
                const granted = await requestNotificationPermission();
                if (!granted) {
                    alert('Notification permission is required for alerts.');
                    return;
                }
            }

            markets[marketIndex].alertEnabled = !markets[marketIndex].alertEnabled;
            markets[marketIndex].alertSent = false; // Reset sent status on toggle
            saveAlertSettings(); // Persist the change

            const bellIcon = document.getElementById(`bell-${marketIndex}`);
            bellIcon.classList.toggle('active', markets[marketIndex].alertEnabled);

            if (markets[marketIndex].alertEnabled) {
                const parts = [];
                if (settings.preOpenEnabled) parts.push(`${settings.preOpenLeadMinutes} minutes before`);
                if (settings.openEnabled) parts.push('when it opens');
                const msg = parts.length ? `You'll be notified ${parts.join(' and ')} for ${markets[marketIndex].name}.` : 'Notifications are currently disabled in Settings.';
                notify('Alert Enabled', msg, `alert-enabled-${markets[marketIndex].name.toLowerCase()}`);
            }
        }

        async function sendMarketNotification(marketName, minutesRemaining) {
            // Use the actual remaining minutes for a more accurate message, rounding to the nearest minute.
            const minutes = minutesRemaining !== undefined ? Math.round(minutesRemaining) : settings.preOpenLeadMinutes;
            const message = minutes > 1
                ? `${marketName} opens in about ${minutes} minutes.`
                : `${marketName} is opening very soon.`;
            return notify('Market Opening Soon!', message, `market-alert-${marketName.toLowerCase()}`);
        }

        async function sendMarketOpenNotification(marketName) {
            return notify('Market Open', `${marketName} is now open.`, `market-open-${marketName.toLowerCase()}`);
        }

        function updateTimers() {
            const nowLocal = DateTime.now();
            let openCount = 0;
            const openNames = [];

            markets.forEach((market) => {
                const statusEl = document.getElementById(`${market.name.toLowerCase()}-status`);
                if (!statusEl) return;

                const nowZ = nowLocal.setZone(market.timezone);

                const openNow = isOpenNow(market, nowZ);
                const wasOpen = market._prevOpen;
                market.isOpen = openNow;

                if (openNow) {
                    openCount++;
                    openNames.push(market.name.toLowerCase());
                    statusEl.textContent = 'Open';
                    statusEl.classList.remove('status-closed');
                    statusEl.classList.add('status-open');
                    // Reset alert for next day while open
                    market.alertSent = false;
                } else {
                    const nextOpenZ = nextBusinessOpen(market, nowZ);
                    const msToOpen = nextOpenZ.toMillis() - nowZ.toMillis();
                    if (msToOpen > 0) {
                        const dur = Duration.fromMillis(msToOpen).shiftTo('hours', 'minutes', 'seconds');
                        const hours = Math.floor(dur.hours);
                        const minutes = Math.floor(dur.minutes) % 60;
                        const seconds = Math.floor(dur.seconds) % 60;

                        statusEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                        const leadMs = Math.max(1, Number(settings.preOpenLeadMinutes || 5)) * 60000;
                        const nextISO = nextOpenZ.toISO();
                        if (market._lastPlannedOpenISO !== nextISO) {
                            market._preAlertSent = false;
                            market._prevMsToOpen = undefined;
                            market._lastPlannedOpenISO = nextISO;
                        }
                        if (settings.preOpenEnabled && market.alertEnabled && !market._preAlertSent) {
                            if (market._prevMsToOpen === undefined || (market._prevMsToOpen > leadMs && msToOpen <= leadMs)) {
                                const minutesRemaining = msToOpen / 60000;
                                sendMarketNotification(market.name, minutesRemaining);
                                market._preAlertSent = true;
                            }
                        }
                        market._prevMsToOpen = msToOpen;
                    } else {
                        statusEl.textContent = 'Calculating...';
                    }

                    statusEl.classList.remove('status-open');
                    statusEl.classList.add('status-closed');
                }

                // Notify on open transition (closed -> open)
                if (settings.openEnabled && market.alertEnabled && wasOpen === false && openNow === true) {
                    sendMarketOpenNotification(market.name);
                }
                // Track previous open state
                market._prevOpen = openNow;
            });

            // Overlap glow
            markets.forEach((market) => {
                const cardEl = document.getElementById(`card-${market.name.toLowerCase()}`);
                if (!cardEl) return;
                if (openCount > 1 && market.isOpen) {
                    cardEl.classList.add('overlap-glow');
                } else {
                    cardEl.classList.remove('overlap-glow');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Secure-context banner for Chrome
            const secureWarning = document.getElementById('secure-warning');
            if (!isSecure()) {
                secureWarning.classList.remove('hidden');
            }

            // --- All Header & Settings Logic ---
            const headerToggle = document.getElementById('header-toggle');
            const collapsibleSection = document.getElementById('collapsible-section');
            const headerArrow = document.getElementById('header-arrow');
            const headerContainer = document.getElementById('header-container');
            const settingsToggle = document.getElementById('settings-toggle');
            const settingsPanel = document.getElementById('settings-panel');
            const debugToggle = document.getElementById('debug-toggle');
            const debugButtons = document.getElementById('debug-buttons');

            const updateCollapsibleHeight = () => {
                // Only run if the section is expanded
                if (collapsibleSection.style.maxHeight !== '0px') {
                    collapsibleSection.style.maxHeight = collapsibleSection.scrollHeight + "px";
                }
            };

            // Main header toggle
            headerToggle.addEventListener('click', () => {
                if (collapsibleSection.style.maxHeight === '0px') {
                    // Expand
                    collapsibleSection.style.maxHeight = collapsibleSection.scrollHeight + "px";
                    headerArrow.classList.remove('rotate-180');
                    headerContainer.classList.add('mb-6');
                } else {
                    // Collapse
                    collapsibleSection.style.maxHeight = '0px';
                    headerArrow.classList.add('rotate-180');
                    headerContainer.classList.remove('mb-6');
                }
            });

            // Settings panel toggle
            settingsToggle.addEventListener('click', () => {
                settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
                // Use a timeout to allow the DOM to reflow before recalculating height
                setTimeout(updateCollapsibleHeight, 10);
            });

            // Debug tools toggle
            debugToggle.addEventListener('click', () => {
                if (debugButtons.style.display === 'none') {
                    debugButtons.style.display = 'flex';
                    debugToggle.textContent = 'Click here to hide notification tools';
                } else {
                    debugButtons.style.display = 'none';
                    debugToggle.textContent = 'Having notification issues? Click here for help';
                }
                // Use a timeout to allow the DOM to reflow before recalculating height
                setTimeout(updateCollapsibleHeight, 10);
            });

            // Initialize settings inputs and their handlers
            const inputPre = document.getElementById('setting-preopen');
            const inputLead = document.getElementById('setting-lead');
            const inputOpen = document.getElementById('setting-open');
            inputPre.checked = !!settings.preOpenEnabled;
            inputLead.value = Number(settings.preOpenLeadMinutes || 5);
            inputOpen.checked = !!settings.openEnabled;

            document.getElementById('settings-save').addEventListener('click', () => {
                const lead = Math.max(1, Math.min(240, parseInt(inputLead.value, 10) || 5));
                settings.preOpenEnabled = !!inputPre.checked;
                settings.openEnabled = !!inputOpen.checked;
                settings.preOpenLeadMinutes = lead;
                saveSettings();
                showToast('Settings saved', `Pre-open: ${settings.preOpenEnabled ? settings.preOpenLeadMinutes + ' min' : 'off'}; Open: ${settings.openEnabled ? 'on' : 'off'}`);
                settingsPanel.style.display = 'none';
                setTimeout(updateCollapsibleHeight, 10); // Also update on save
            });

            document.getElementById('settings-reset').addEventListener('click', () => {
                settings = { ...defaultSettings };
                saveSettings();
                inputPre.checked = settings.preOpenEnabled;
                inputLead.value = settings.preOpenLeadMinutes;
                inputOpen.checked = settings.openEnabled;
                showToast('Settings reset', 'Defaults restored');
            });

            // Test notification button
            document.getElementById('test-notification').addEventListener('click', async () => {
                const button = document.getElementById('test-notification');
                const original = button.textContent;
                button.textContent = 'Testing...';
                button.disabled = true;
                try {
                    const success = await notify('Test Notification', 'Market Hours notifications are working!', 'market-hours-test');
                    button.textContent = success ? 'Test Sent!' : 'Test Failed';
                } catch (e) {
                    console.error('Error in test notification:', e);
                    button.textContent = 'Error';
                } finally {
                    setTimeout(() => {
                        button.textContent = original;
                        button.disabled = false;
                    }, 2000);
                }
            });

            // Check settings button
            document.getElementById('check-settings').addEventListener('click', () => {
                const info = [
                    `Notification API Support: ${'Notification' in window}`,
                    `Permission Status: ${Notification?.permission || 'Unknown'}`,
                    `Internal Permission State: ${notificationPermissionGranted}`,
                    `Service Worker Support: ${'serviceWorker' in navigator}`,
                    `Secure Context: ${isSecure()}`,
                    `User Agent: ${navigator.userAgent}`,
                    ``,
                    `If notifications aren't showing:`,
                    `1) Serve this page via https:// or http://localhost`,
                    `2) Check browser site permissions for Notifications`,
                    `3) Check OS notification settings`,
                    `4) Try an incognito window`
                ].join('\n');
                console.log('=== Notification Debug Info ===');
                console.log(info);
                alert(info);
            });

            // Start collapsed by default
            collapsibleSection.style.maxHeight = '0px';
            headerArrow.classList.add('rotate-180');

            // Initialize permission state
            if ('Notification' in window && Notification.permission === 'granted') {
                notificationPermissionGranted = true;
            }

            // Try to register service worker (Chrome/Firefox on secure origins)
            swRegistration = await registerServiceWorker();

            // Log computed open/close in UTC for visibility
            console.log('=== Market Time Windows (today, zone local and UTC) ===');
            baseMarkets.forEach((m) => {
                const nowZ = DateTime.now().setZone(m.timezone);
                const { openZ, closeZ } = openCloseOnDay(m, nowZ);
                console.log(
                    `${m.name} (${m.timezone}) | Local: ${openZ.toFormat('HH:mm')} - ${closeZ.toFormat('HH:mm')} | UTC: ${openZ.toUTC().toFormat('HH:mm')} - ${closeZ.toUTC().toFormat('HH:mm')}`
                );
            });
            console.log('=======================================================');

            initializeDashboard();
            updateTimers();
            setInterval(updateTimers, 1000);
        });
    </script>
</body>
</html>
